---
bibliography: pepr-pub.bib
output:
  word_document: default
  pdf_document:
    fig_caption: yes
    number_sections: yes
  html_document:
    fig_caption: yes
    keep_md: yes
    number_sections: yes
---
```{r, echo = FALSE, message = FALSE}
source("rm_metadata.R")
```

```{r, echo = FALSE, message=FALSE}
library(png)
library(grid)
library(peprr)
library(dplyr)
library(knitr)
```

```{r echo=FALSE, message=FALSE} 
peprDB <- dplyr::src_sqlite(db_path)
```

# Results
## Summary of Sequencing Datasets
The MiSeq sequencing run resulted in over 1.5 million pair end (3 million total) reads per library with a median read length just under 250 bp.  Whereas the PGM sequencing run produced about 0.5 million reads per library with a median read length around 235 bp.  The higher throughput and paried end reads resulted in a higher per library coverage for MiSeq compared to PGM (~140X vs. ~30X).  Despite using the 400bp sequencing chemistry the PGM median read length was less than 250 bp.  The three PacBio datasets are technical sequencing replicates (SMRT cells) from the same sequencing library, with a median read lengths of XYZ, and throughput of XYZ, resulting in a total of ??X coverage.

```{r echo = FALSE, message=FALSE, warning=FALSE}
kable(seq_summary_table(peprDB), 
      round = 0, row.names = FALSE, caption = "Summary of sequencing datasets")
```

## Genome Assembly
The _de-novo_ assembly using PacBio data was performed using the HGAP assembler, as part of the SMRTanalysis software (__version info__), resulting in a closed genome and plasmid assembly. Optical mapping data generated by the OpGen Argus system was used to validate the genome assembly.  Optical mapping data agreed with the _de novo_ assembly (Figure AssemblyComp). The plasmid is too small for OpGen optical mapping technology and therefore the plasmid assmebly was not validated with the optical mapping data.  

```{r echo = FALSE, message=FALSE, warning=FALSE, fig.scap= "Comparison of optical map data to genome assembly.", fig.cap = "Alignment of in-silico genome map generated from the PacBio HGAP assembly to the OpGen optical map.  Blue bars in map represent NocI restriction sites, black lines indicate co-linear regions."}
# __SPECIFIC TO RM__
grid.raster(readPNG("opgen_assembly_comparison.png"))
```

The short read sequencing data supported the _de novo_ genome assembly. Pilon, a program developed for genome finishing and variant calling, identifies positions in the a genome assembly that exbiting characteristics of missassemblies and base call errors.  Running Pilon using the MiSeq data did not identify any missassemblies or base call errors.  Pilon did identifed __TODO ## TODO__ one and two base indels, and __TODO ## TODO__ larger deletions in the reference assembly.  Evaluation of the mapped MiSeq and PGM reads to these regions identicates that __TODO figures and summary statement TODO___.

## Base Level Analysis
### Base Purity
A base purity metric was used for base level analysis.  The purity value is the number bases in reads aligned to a genome position that are in agreement with the reference base divided by the total number of reads aligned to the position.  Comparison of the purity values between for all positions in the genome for two orthogonal sequencing methods was used to differentiate between positions with low purity values due to platform specific biases and those due to true biological diversity.  For RM8376 no positions have purity values less than 0.95 for both platforms, and only 4 positions with purity values less than 0.97 \% for both platforms, indicating a low level of biological variability within the material.  A number (need to calculate) of positions have purity values <0.98 for MiSeq and >0.98 for PGM or <0.98 for PGM and >0.98 for MiSeq.  These the low purity values on one platform and not another indicate a platform specific bias.  We are assuming that a systematic bias or sequencing error is responsible for the lower value. The reference base is identified using a third orthogonal sequencing method (PacBio) and thus a low value for one of the two short reads sequencing platforms represents agreement between two of the three sequencing methods.  It is also important to acknowledge that the two platforms in agreement are susceptible to the same bias and thus the outlier platform could indicate the true value.  The sequencing technology used to chracterize the material is still maturing and an incomplete understanding of platform specific biases limits our ability to provide a confidence value for the base calls.

```{r cache = TRUE, echo = FALSE, message = FALSE, warnings = FALSE}
source("base_purity_analysis.R")
```

```{r echo = FALSE, message = FALSE, warnings = FALSE}
pur_dat_id %>% group_by(pur_group) %>% summarise(count = n()) %>% kable(row.names = NA, caption = "Number of genome positions with purity values higher and lower than 0.99 for MiSeq and PGM sequencing platforms.")
```

```{r cache = TRUE, echo = FALSE, message = FALSE, warnings = FALSE, fig.show = 'asis', fig.cap= "Comparison of base purity values for PGM and MiSeq. Positions are colored based of high and low purity values for the two sequencing platforms."}
ggplot2::ggplot(pur_dat_id_filt) +
    ggplot2::geom_point(ggplot2::aes(x = plat1, y = plat2, color = pur_group),
                        alpha = 0.5) +
    ggplot2::labs(x = "MiSeq", y = "PGM") + ggplot2::theme_bw() + 
    ggplot2::xlim(min_val, 1) + ggplot2::ylim(min_val, 1)
```

Correlating the four groups of purity values, with different bias metrics can help identify positions with low purity values due to measurement biases and thoes that represent true biological variability. Metrics calculated by samtools test for for biases in mapping quality, read position, base quality, and strand.  Based on tentile (?? is this correct term) metric values, there was no clear distinction between the four groups (low purity for MiSeq and PGM, low purity for PGM and high purity for MiSeq, and high purity for both MiSeq and PGM) (Supplemental Results Bias metrics).  To differentiate between positions with low purity due to measurement error than thoes due to biological variablity a clear distinction between metrics values for the high and low purity groups should be observed. Due to a lack of distiction between the metric values for the different groups the level of biological variability is below the limit of detection for this approach.

### Sequence homogeneity
The genomic material homogeneity was assessed through a pairwise statistical analysis of the replicate MiSeq datasets using the varsan somatic variant caller.  The pairwise variant analysis failed to identify any statistically significant base level differences among the replicates.

```{r echo =FALSE}
kable(homogeneity_sig_table(peprDB, rename_cols = TRUE), 
      row.names = FALSE,
      caption = "Pairwise variant analysis results")
```

#### Genomic Purity
Based on taxonomic assignment of the PGM and MiSeq data the reference material has minimal if any genomic contaminants (Figure GenPur BoxPlot), __TODO__ add calculations__TODO__.  The most abundant contaminant was _Escherichia coli_ which is a well documented contaminant of molecular biology reagents. Lower abundance contaminants are most likely bioinformatic errors and not true contaminants. To provide a conservative estimate of the genomic purity the stated value assumes all reads identified as not beloning to the genus _Staphylococcus_ are contamiants.

```{r echo = FALSE, fig.show = 'asis', fig.cap= "Proportion of reads from contaminant DNA.", warning=FALSE, message=FALSE}
contam_counts_figure(peprDB, rm_genus)
```

```{r echo = FALSE, message=FALSE, warning=FALSE, fig.height = 6, fig.cap= "Breakdown of contaminants by organism.",fig.retina=TRUE}
contam_point_line_figure(peprDB, rm_genus)
```